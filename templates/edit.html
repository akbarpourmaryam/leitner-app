
{% extends "base.html" %}
{% block content %}
<div class="card">
  <h2>‚úèÔ∏è Edit Problem</h2>
  <form method="post">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" name="title" value="{{ card.title }}">
    
    <div class="form-group">
      <label>LeetCode Problem URL</label>
      <input type="url" name="link" value="{{ card.link }}" required>
      <small class="muted">Update the URL to automatically fetch a new title</small>
    </div>
    
    <div class="form-group">
      <label>Note</label>
      <textarea name="note" id="note-textarea-edit">{{ card.idea or '' }}</textarea>
      <button type="button" class="btn btn-outline btn-sm" id="ai-improve-btn-edit" style="margin-top: 8px;" onclick="improveNoteWithAI()">
        ‚ú® Improve with AI
      </button>
      <small class="muted" id="ai-status-edit" style="display: none; margin-left: 12px;"></small>
    </div>
    
    <div class="form-group">
      <p class="muted"><strong>Current Box:</strong> Box {{ card.leitner_box }} | <strong>Practiced On:</strong> {{ card.solved_date }} | <strong>Next Review:</strong> {{ card.next_review }}</p>
      <small class="muted">Box level and review dates can only be changed during review sessions.</small>
    </div>
    
    <div class="right">
      <a href="{{ url_for('dashboard') }}" class="btn btn-outline" style="text-decoration:none;display:inline-block;margin-right:12px;">Cancel</a>
      <button class="btn">Save Changes</button>
    </div>
  </form>
</div>

<script>
async function improveNoteWithAI() {
  const textarea = document.getElementById('note-textarea-edit');
  const btn = document.getElementById('ai-improve-btn-edit');
  const status = document.getElementById('ai-status-edit');
  const noteText = textarea.value.trim();
  
  if (!noteText) {
    alert('Please write some notes first before using AI to improve them!');
    return;
  }
  
  // Disable button and show loading
  btn.disabled = true;
  btn.textContent = 'ü§ñ Improving...';
  status.style.display = 'inline';
  status.textContent = 'AI is working...';
  status.style.color = '#667eea';
  
  try {
    const response = await fetch('/api/improve-note', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        note: noteText,
        title: '{{ card.title }}'
      })
    });
    
    // Check if response is JSON
    const contentType = response.headers.get('content-type');
    if (!contentType || !contentType.includes('application/json')) {
      throw new Error('Server returned an error. Check if you are logged in and API key is configured.');
    }
    
    const data = await response.json();
    
    if (data.success) {
      textarea.value = data.improved_note;
      status.textContent = '‚úì Improved!';
      status.style.color = '#059669';
      setTimeout(() => {
        status.style.display = 'none';
      }, 3000);
    } else {
      status.textContent = '‚úó ' + (data.error || 'Unknown error');
      status.style.color = '#dc2626';
    }
  } catch (error) {
    console.error('AI Error:', error);
    status.textContent = '‚úó ' + error.message;
    status.style.color = '#dc2626';
  } finally {
    btn.disabled = false;
    btn.textContent = '‚ú® Improve with AI';
  }
}
</script>
{% endblock %}

